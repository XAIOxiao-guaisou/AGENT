# å°çº¢ä¹¦çˆ¬è™« - Main Entry Point
# Auto-generated by Antigravity P3

import asyncio
import json
import logging
import sys
from pathlib import Path
from typing import Dict, Any, Optional

# Add project root to path
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

# Import project modules
try:
    from core.xiaohongshu_crawler import XiaohongshuCrawler
    from utils.helpers import setup_logging, validate_config, retry_with_exponential_backoff
except ImportError as e:
    print(f"âŒ å¯¼å…¥æ¨¡å—å¤±è´¥: {e}")
    print("è¯·ç¡®ä¿é¡¹ç›®ç»“æ„å®Œæ•´ï¼Œå¹¶å·²å®‰è£…æ‰€æœ‰ä¾èµ–")
    sys.exit(1)


class XiaohongshuSpider:
    """å°çº¢ä¹¦çˆ¬è™«ä¸»æ§åˆ¶å™¨"""
    
    def __init__(self, config_path: Optional[Path] = None):
        """
        åˆå§‹åŒ–çˆ¬è™«
        
        Args:
            config_path: é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤ä¸º config/settings.json
        """
        self.project_root = Path(__file__).parent
        self.config_path = config_path or self.project_root / "config" / "settings.json"
        self.config: Dict[str, Any] = {}
        self.crawler: Optional[XiaohongshuCrawler] = None
        self.logger = logging.getLogger(__name__)
    
    def track_performance(self, func):
        """æ€§èƒ½ç›‘æ§è£…é¥°å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰"""
        def wrapper(*args, **kwargs):
            import time
            start_time = time.time()
            instance = args[0] if args else None
            func_name = func.__name__
            
            if instance and hasattr(instance, 'logger'):
                instance.logger.debug(f"å¼€å§‹æ‰§è¡Œ: {func_name}")
            
            try:
                result = func(*args, **kwargs)
                elapsed = time.time() - start_time
                
                if instance and hasattr(instance, 'logger'):
                    instance.logger.debug(f"å®Œæˆæ‰§è¡Œ: {func_name}, è€—æ—¶: {elapsed:.2f}ç§’")
                
                return result
            except Exception as e:
                elapsed = time.time() - start_time
                if instance and hasattr(instance, 'logger'):
                    instance.logger.error(f"æ‰§è¡Œå¤±è´¥: {func_name}, è€—æ—¶: {elapsed:.2f}ç§’, é”™è¯¯: {e}")
                raise
        
        return wrapper
    
    @track_performance
    def load_config(self) -> bool:
        """
        åŠ è½½é…ç½®æ–‡ä»¶
        
        Returns:
            bool: é…ç½®åŠ è½½æ˜¯å¦æˆåŠŸ
        """
        try:
            if not self.config_path.exists():
                self.logger.error(f"é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {self.config_path}")
                return False
                
            with open(self.config_path, 'r', encoding='utf-8') as f:
                self.config = json.load(f)
                
            # éªŒè¯å¿…è¦é…ç½®
            required_keys = ['api_keys', 'crawler_settings', 'output_settings']
            for key in required_keys:
                if key not in self.config:
                    self.logger.error(f"é…ç½®ç¼ºå°‘å¿…è¦å­—æ®µ: {key}")
                    return False
                    
            self.logger.info("é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ")
            return True
            
        except json.JSONDecodeError as e:
            self.logger.error(f"é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯: {e}")
            return False
        except Exception as e:
            self.logger.error(f"åŠ è½½é…ç½®æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯: {e}")
            return False
    
    @track_performance
    def initialize_environment(self) -> bool:
        """
        åˆå§‹åŒ–è¿è¡Œç¯å¢ƒ
        
        Returns:
            bool: ç¯å¢ƒåˆå§‹åŒ–æ˜¯å¦æˆåŠŸ
        """
        try:
            # æ£€æŸ¥æ•°æ®ç›®å½•
            data_dir = self.project_root / "data"
            data_dir.mkdir(exist_ok=True)
            self.logger.info(f"æ•°æ®ç›®å½•å·²å‡†å¤‡: {data_dir}")
            
            # æ£€æŸ¥æµè§ˆå™¨ç¯å¢ƒ
            # è¿™é‡Œå¯ä»¥æ·»åŠ Playwrightæµè§ˆå™¨æ£€æŸ¥é€»è¾‘
            # æš‚æ—¶åªè®°å½•æ—¥å¿—
            self.logger.info("ç¯å¢ƒæ£€æŸ¥å®Œæˆ")
            return True
            
        except Exception as e:
            self.logger.error(f"ç¯å¢ƒåˆå§‹åŒ–å¤±è´¥: {e}")
            return False
    
    @retry_with_exponential_backoff(max_retries=3)
    @track_performance
    async def run_crawler(self) -> bool:
        """
        è¿è¡Œçˆ¬è™«ä¸»é€»è¾‘
        
        Returns:
            bool: çˆ¬è™«æ‰§è¡Œæ˜¯å¦æˆåŠŸ
        """
        try:
            # åˆå§‹åŒ–çˆ¬è™«
            self.crawler = XiaohongshuCrawler(self.config)
            
            # æ‰§è¡Œçˆ¬è™«ä»»åŠ¡
            self.logger.info("å¼€å§‹æ‰§è¡Œå°çº¢ä¹¦çˆ¬è™«ä»»åŠ¡...")
            
            # æ ¹æ®é…ç½®æ‰§è¡Œä¸åŒçš„çˆ¬è™«ä»»åŠ¡
            tasks = self.config.get('crawler_settings', {}).get('tasks', [])
            
            for task in tasks:
                task_type = task.get('type', '')
                target = task.get('target', '')
                
                if not task_type or not target:
                    self.logger.warning(f"è·³è¿‡æ— æ•ˆä»»åŠ¡: {task}")
                    continue
                    
                self.logger.info(f"æ‰§è¡Œä»»åŠ¡: {task_type} - {target}")
                
                if task_type == 'user_profile':
                    result = await self.crawler.crawl_user_profile(target)
                elif task_type == 'user_posts':
                    result = await self.crawler.crawl_user_posts(target)
                elif task_type == 'search_keyword':
                    keyword = target
                    limit = task.get('limit', 10)
                    result = await self.crawler.search_keyword(keyword, limit)
                else:
                    self.logger.warning(f"æœªçŸ¥ä»»åŠ¡ç±»å‹: {task_type}")
                    continue
                
                if result:
                    self.logger.info(f"ä»»åŠ¡å®Œæˆ: {task_type} - {target}")
                else:
                    self.logger.error(f"ä»»åŠ¡å¤±è´¥: {task_type} - {target}")
            
            return True
            
        except Exception as e:
            self.logger.error(f"çˆ¬è™«æ‰§è¡Œå¤±è´¥: {e}")
            return False
    
    @track_performance
    async def run(self) -> bool:
        """
        è¿è¡Œä¸»æµç¨‹
        
        Returns:
            bool: æ•´ä¸ªæµç¨‹æ˜¯å¦æˆåŠŸ
        """
        try:
            # 1. è®¾ç½®æ—¥å¿—
            setup_logging()
            self.logger.info("ğŸš€ å°çº¢ä¹¦çˆ¬è™«å¯åŠ¨ä¸­...")
            
            # 2. åŠ è½½é…ç½®
            if not self.load_config():
                return False
                
            # 3. åˆå§‹åŒ–ç¯å¢ƒ
            if not self.initialize_environment():
                return False
                
            # 4. éªŒè¯é…ç½®
            if not validate_config(self.config):
                self.logger.error("é…ç½®éªŒè¯å¤±è´¥")
                return False
                
            # 5. è¿è¡Œçˆ¬è™«
            success = await self.run_crawler()
            
            if success:
                self.logger.info("âœ… å°çº¢ä¹¦çˆ¬è™«ä»»åŠ¡å®Œæˆ")
            else:
                self.logger.error("âŒ å°çº¢ä¹¦çˆ¬è™«ä»»åŠ¡å¤±è´¥")
                
            return success
            
        except KeyboardInterrupt:
            self.logger.info("â¹ï¸ ç”¨æˆ·ä¸­æ–­æ‰§è¡Œ")
            return False
        except Exception as e:
            self.logger.error(f"âŒ ç¨‹åºæ‰§è¡Œå¼‚å¸¸: {e}")
            return False


def main():
    """Main entry point"""
    spider = XiaohongshuSpider()
    
    # è¿è¡Œå¼‚æ­¥ä¸»å‡½æ•°
    try:
        success = asyncio.run(spider.run())
        sys.exit(0 if success else 1)
    except RuntimeError as e:
        if "Event loop is closed" in str(e):
            # å¿½ç•¥äº‹ä»¶å¾ªç¯å…³é—­çš„é”™è¯¯
            pass
        else:
            print(f"âŒ è¿è¡Œæ—¶é”™è¯¯: {e}")
            sys.exit(1)


if __name__ == "__main__":
    main()